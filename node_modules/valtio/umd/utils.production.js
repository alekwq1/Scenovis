!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("valtio/vanilla"),require("proxy-compare")):"function"==typeof define&&define.amd?define(["exports","valtio/vanilla","proxy-compare"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).valtioUtils={},e.valtioVanilla,e.proxyCompare)}(this,(function(e,t,n){"use strict";var r;var i=Symbol();var a=new WeakMap,o=new WeakMap,s=function e(t,n){var r=a.get(t);r&&(r[0].forEach((function(n){var r=n.d;t!==r&&e(r)})),++r[2],n&&r[3].add(n))},u=function e(t){var n=a.get(t);n&&(--n[2],n[2]||(n[3].forEach((function(e){return e()})),n[3].clear()),n[0].forEach((function(n){var r=n.d;t!==r&&e(r)})))},c=function(e){var n=e.s,r=e.d,i=o.get(r);i||(i=[new Set],o.set(e.d,i)),i[0].add(e);var c=a.get(n);if(!c){var f=new Set,d=t.subscribe(n,(function(e){f.forEach((function(t){var r=t.d,i=t.c,a=t.n,o=t.i;n===r&&e.every((function(e){return 1===e[1].length&&o.includes(e[1][0])}))||t.p||(s(n,i),a?u(n):t.p=Promise.resolve().then((function(){delete t.p,u(n)})))}))}),!0);c=[f,d,0,new Set],a.set(n,c)}c[0].add(e)},f=function(e){var t=e.s,n=e.d,r=o.get(n);null==r||r[0].delete(e),0===(null==r?void 0:r[0].size)&&o.delete(n);var i=a.get(t);if(i){var s=i[0],u=i[1];s.delete(e),s.size||(u(),a.delete(t))}},d=function(e){var t=o.get(e);return t?Array.from(t[0]):[]},l={add:c,remove:f,list:d};function p(e,n){var r=(null==n?void 0:n.proxy)||t.proxy({}),i=!(null==n||!n.sync),o=Object.keys(e);return o.forEach((function(n){if(Object.getOwnPropertyDescriptor(r,n))throw new Error("object property already defined");var s=e[n],u=null;!function e(){if(u){if(Array.from(u).map((function(t){var n,r,i,o=t[0];return n=o,r=e,!(null==(i=a.get(n))||!i[2]||(i[3].add(r),0))})).some((function(e){return e})))return;if(Array.from(u).every((function(e){var n=e[0],r=e[1];return t.getVersion(n)===r.v})))return}var d=new Map,l=s((function(e){return d.set(e,{v:t.getVersion(e)}),e})),p=function(){var t;d.forEach((function(t,a){var s,f,d=null==(s=u)||null==(f=s.get(a))?void 0:f.s;if(d)t.s=d;else{var l={s:a,d:r,k:n,c:e,n:i,i:o};c(l),t.s=l}})),null==(t=u)||t.forEach((function(e,t){!d.has(t)&&e.s&&f(e.s)})),u=d};l instanceof Promise?l.finally(p):p(),r[n]=l}()})),r}function h(e,t){for(var n in t){(a=t[n]).configurable=a.enumerable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,n,a)}if(Object.getOwnPropertySymbols)for(var r=Object.getOwnPropertySymbols(t),i=0;i<r.length;i++){var a,o=r[i];(a=t[o]).configurable=a.enumerable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,o,a)}return e}e.addComputed=function(e,t,n){void 0===n&&(n=e),console.warn("addComputed is deprecated. Please consider using `derive` or `proxyWithComputed` instead. Falling back to emulation with derive.");var r={};return Object.keys(t).forEach((function(n){r[n]=function(r){return t[n](r(e))}})),p(r,{proxy:n})},e.derive=p,e.devtools=function(e,n){"string"==typeof n&&(console.warn("[Deprecated] Please use option object instead of name string"),n={name:n});var r,a=n||{},o=a.enabled,s=a.name,u=void 0===s?"":s;try{r=null!=o&&o&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(r){var c=!1,f=r.connect({name:u}),d=t.subscribe(e,(function(n){var r=n.filter((function(e){return e[0],e[1][0]!==i})).map((function(e){return e[0]+":"+e[1].map(String).join(".")})).join(", ");if(r)if(c)c=!1;else{var a=Object.assign({},t.snapshot(e));delete a[i],f.send({type:r,updatedAt:(new Date).toLocaleString()},a)}})),l=f.subscribe((function(n){var r,a;if("ACTION"===n.type&&n.payload)try{Object.assign(e,JSON.parse(n.payload))}catch(e){console.error("please dispatch a serializable value that JSON.parse() and proxy() support\n",e)}if("DISPATCH"===n.type&&n.state){var o,s;if("JUMP_TO_ACTION"===(null==(o=n.payload)?void 0:o.type)||"JUMP_TO_STATE"===(null==(s=n.payload)?void 0:s.type)){c=!0;var u=JSON.parse(n.state);Object.assign(e,u)}e[i]=n}else if("DISPATCH"===n.type&&"COMMIT"===(null==(r=n.payload)?void 0:r.type))f.init(t.snapshot(e));else if("DISPATCH"===n.type&&"IMPORT_STATE"===(null==(a=n.payload)?void 0:a.type)){var d,l,p=null==(d=n.payload.nextLiftedState)?void 0:d.actionsById,h=(null==(l=n.payload.nextLiftedState)?void 0:l.computedStates)||[];c=!0,h.forEach((function(n,r){var i=n.state,a=p[r]||"No action found";Object.assign(e,i),0===r?f.init(t.snapshot(e)):f.send(a,t.snapshot(e))}))}}));return f.init(t.snapshot(e)),function(){d(),null==l||l()}}},e.proxyMap=function(e){var n,r,i,a=t.proxy((r={data:Array.from(e||[]),has:function(e){return this.data.some((function(t){return t[0]===e}))},set:function(e,t){var n=this.data.find((function(t){return t[0]===e}));return n?n[1]=t:this.data.push([e,t]),this},get:function(e){var t;return null==(t=this.data.find((function(t){return t[0]===e})))?void 0:t[1]},delete:function(e){var t=this.data.findIndex((function(t){return t[0]===e}));return-1!==t&&(this.data.splice(t,1),!0)},clear:function(){this.data.splice(0)},get size(){return this.data.length},toJSON:function(){return{}},forEach:function(e){var t=this;this.data.forEach((function(n){e(n[1],n[0],t)}))},keys:function(){return this.data.map((function(e){return e[0]})).values()},values:function(){return this.data.map((function(e){return e[1]})).values()},entries:function(){return new Map(this.data).entries()}},(i={})[n=Symbol.toStringTag]=i[n]||{},i[n].get=function(){return"Map"},r[Symbol.iterator]=function(){return this.entries()},h(r,i),r));return Object.defineProperties(a,{data:{enumerable:!1},size:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(a),a},e.proxySet=function(e){var n,r,i,a=t.proxy((r={data:Array.from(new Set(e)),has:function(e){return-1!==this.data.indexOf(e)},add:function(e){var n=!1;return"object"==typeof e&&null!==e&&(n=-1!==this.data.indexOf(t.proxy(e))),-1!==this.data.indexOf(e)||n||this.data.push(e),this},delete:function(e){var t=this.data.indexOf(e);return-1!==t&&(this.data.splice(t,1),!0)},clear:function(){this.data.splice(0)},get size(){return this.data.length},forEach:function(e){var t=this;this.data.forEach((function(n){e(n,n,t)}))}},(i={})[n=Symbol.toStringTag]=i[n]||{},i[n].get=function(){return"Set"},r.toJSON=function(){return{}},r[Symbol.iterator]=function(){return this.data[Symbol.iterator]()},r.values=function(){return this.data.values()},r.keys=function(){return this.data.values()},r.entries=function(){return new Set(this.data).entries()},h(r,i),r));return Object.defineProperties(a,{data:{enumerable:!1},size:{enumerable:!1},toJSON:{enumerable:!1}}),Object.seal(a),a},e.proxyWithComputed=function(e,r){Object.keys(r).forEach((function(a){if(Object.getOwnPropertyDescriptor(e,a))throw new Error("object property already defined");var o,s,u=r[a],c="function"==typeof u?{get:u}:u,f=c.get,d=c.set,l=new WeakMap,p={get:function(){var e=t.snapshot(i);return s&&!n.isChanged(s,e,l)||(l=new WeakMap,o=f(n.createProxy(e,l)),s=e),o}};d&&(p.set=function(e){return d(i,e)}),Object.defineProperty(e,a,p)}));var i=t.proxy(e);return i},e.proxyWithHistory=function(e,n){void 0===n&&(n=!1);var r=t.proxy({value:e,history:t.ref({wip:e,snapshots:[],index:-1}),canUndo:function(){return r.history.index>0},undo:function(){r.canUndo()&&(r.value=r.history.wip=r.history.snapshots[--r.history.index],r.history.snapshots[r.history.index]=t.snapshot(r).value)},canRedo:function(){return r.history.index<r.history.snapshots.length-1},redo:function(){r.canRedo()&&(r.value=r.history.wip=r.history.snapshots[++r.history.index],r.history.snapshots[r.history.index]=t.snapshot(r).value)},saveHistory:function(){r.history.snapshots.splice(r.history.index+1),r.history.snapshots.push(t.snapshot(r).value),++r.history.index},subscribe:function(){return t.subscribe(r,(function(e){e.every((function(e){return"value"===e[1][0]&&("set"!==e[0]||e[2]!==r.history.wip)}))&&r.saveHistory()}))}});return r.saveHistory(),n||r.subscribe(),r},e.subscribeKey=function(e,n,r,i){return t.subscribe(e,(function(t){t.some((function(e){return e[1][0]===n}))&&r(e[n])}),i)},e.underive=function(e,t){var n=null!=t&&t.delete?new Set:null;d(e).forEach((function(e){var r=e.k;null!=t&&t.keys&&!t.keys.includes(r)||(f(e),n&&n.add(r))})),n&&n.forEach((function(t){delete e[t]}))},e.unstable_deriveSubscriptions=l,e.watch=function(e,n){var i=!0,a=new Set,o=new Map,s=function(){i&&(i=!1,a.forEach((function(e){return e()})),a.clear(),o.forEach((function(e){return e()})),o.clear())};return r&&r.add(s),function s(){if(i){a.forEach((function(e){return e()})),a.clear();var u=new Set,c=r;r=a;try{var f=e((function(e){return u.add(e),e}));f&&a.add(f)}finally{r=c}o.forEach((function(e,t){u.has(t)?u.delete(t):(o.delete(t),e())})),u.forEach((function(e){var r=t.subscribe(e,s,null==n?void 0:n.sync);o.set(e,r)}))}}(),s},Object.defineProperty(e,"__esModule",{value:!0})}));
